services:
  # ─── Netbird Management ───────────────────────────────────────────────────
  # Core API server — handles peer registry, ACL policies, setup keys
  #
  netbird-management:
    image: netbirdio/management:latest
    container_name: netbird-management
    restart: unless-stopped
    command:
      - --port=80
      - --log-file=console
      - --log-level=info
      - --disable-anonymous-metrics=false
      - --single-account-mode-domain={NETBIRD_DOMAIN}
      - --dns-domain=netbird.selfhosted
    environment:
      - NETBIRD_STORE_ENGINE=sqlite
    volumes:
      - /opt/netbird/management:/var/lib/netbird
    networks:
      - netbird
    security_opt:
      - no-new-privileges:true

  # ─── Netbird Signal ───────────────────────────────────────────────────────
  # WebRTC signaling — helps peers discover each other
  #
  netbird-signal:
    image: netbirdio/signal:latest
    container_name: netbird-signal
    restart: unless-stopped
    volumes:
      - /opt/netbird/signal:/var/lib/netbird
    ports:
      - "0.0.0.0:10000:10000"  # gRPC / signal
    networks:
      - netbird
    security_opt:
      - no-new-privileges:true

  # ─── Netbird Relay ────────────────────────────────────────────────────────
  # Fallback relay for peers that cannot connect directly (strict NAT)
  #
  netbird-relay:
    image: netbirdio/relay:latest
    container_name: netbird-relay
    restart: unless-stopped
    environment:
      - NB_LOG_LEVEL=info
      - NB_LISTEN_ADDRESS=:33080
      - NB_EXPOSED_ADDRESS=rels://{NETBIRD_DOMAIN}:33080
      - NB_AUTH_SECRET={MANAGEMENT_SECRET}
    ports:
      - "0.0.0.0:33080:33080"
    networks:
      - netbird
    security_opt:
      - no-new-privileges:true

  # ─── Coturn (STUN/TURN) ───────────────────────────────────────────────────
  # Enables NAT traversal for peers behind symmetric NAT
  #
  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    restart: unless-stopped
    network_mode: host
    command:
      - --log-file=stdout
      - --external-ip={NETBIRD_DOMAIN}
      - --min-port=49152
      - --max-port=65535
      - --use-auth-secret
      - --static-auth-secret={TURN_SECRET}
      - --realm={NETBIRD_DOMAIN}
      - --no-cli
      - --no-tlsv1
      - --no-tlsv1_1

  # ─── Nginx (TLS + reverse proxy) ─────────────────────────────────────────
  # Handles HTTPS for management API; obtains certs via Let's Encrypt
  #
  netbird-nginx:
    image: nginx:alpine
    container_name: netbird-nginx
    restart: unless-stopped
    volumes:
      - /opt/netbird/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/netbird/nginx/certs:/etc/nginx/certs
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
    networks:
      - netbird
    depends_on:
      - netbird-management
    security_opt:
      - no-new-privileges:true

  # ─── Certbot ──────────────────────────────────────────────────────────────
  # Manages Let's Encrypt TLS certificates for the management API
  #
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - /opt/netbird/nginx/certs:/etc/letsencrypt
      - /opt/netbird/nginx/certbot-webroot:/var/www/certbot
    command: >
      certonly --webroot --webroot-path=/var/www/certbot
      --email {ACME_EMAIL} --agree-tos --no-eff-email
      --domains {NETBIRD_DOMAIN}
    networks:
      - netbird

networks:
  netbird:
    driver: bridge
